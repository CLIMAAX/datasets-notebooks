---
title: "PCA Calculator for Heatwave SoVI"
author: "Alona Bogdanova"
date: "2024-05-22"
output: html_document
---




###### TO RUN THE CODE AND SEE THE RESULTS PRESS THE "KNIT" BUTTON ABOVE ######






```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.




## PCA Analysis

This part of the code will perform PCA analysis. The outputs will be saved in the output->PCA folder. The rest of the analysis will be continued in the initial Jupyter Notebook.


## Installing packages
First, it is necessary to install packages and set up the working directory.
```{r}

# Set CRAN mirror
options(repos = c(CRAN = "https://cran.rstudio.com/"))

# List of required packages
packages <- c("readr", "rstudioapi", "psych")

# Function to check and install missing packages, and load them
install_and_load <- function(package) {
  if (!require(package, character.only = TRUE, quietly = TRUE)) {
    install.packages(package)
  }
  if (!require(package, character.only = TRUE, quietly = TRUE)) {
    library(package, character.only = TRUE)
  }
}

# Applying the function to each package
lapply(packages, install_and_load)

```


### The version of the psych package has to be 2.4.3 for consistence of the results
```{r}
desired_psych_version <- "2.4.3"
if (packageVersion("psych") != desired_psych_version) {
  # Install the desired version from CRAN archive if it is not the correct version
  psych_archive_url <- sprintf("https://cran.r-project.org/src/contrib/Archive/psych/psych_%s.tar.gz", desired_psych_version)
  install.packages(psych_archive_url, repos = NULL, type = "source")
  library(psych, character.only = TRUE)
}

```

### Check the package version
```{r}
packageVersion("psych")
```


## Setting up the working directory
This part creates the PCA folder in the output folder to store all the PCA analysis results for further work in the Jupyter Notebook.
```{r}
#INPUT
# Get the path to the currently open R script in RStudio
script_path <- getActiveDocumentContext()$path
knitr::opts_knit$set(root.dir = normalizePath(dirname(script_path)))

# Set the working directory to the script's directory
script_dir <- dirname(script_path)
setwd(script_dir)


# Path to the directory containing the data files
data_dir <- "./output/z_scores"


#OUTPUT
# Define the path for the output directory
output_dir <- file.path(getwd(), "output")

# Create the output directory if it doesn't already exist
if (!dir.exists(output_dir)) {
  dir.create(output_dir)
  print("Output directory created.")
} else {
  print("Output directory already exists.")
}

# Define the path for a subdirectory within the output directory, e.g., "results"
results_dir <- file.path(output_dir, "PCA")

# Create the results subdirectory if it doesn't already exist
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
  print("PCA subdirectory created.")
} else {
  print("PCA subdirectory already exists.")
}

```

## PERFORMING PCA
This part of the code performs the PCA analysis. After running the code a new folder is created: output-> PCA. There the datasets with eigen values of rotated principal components, variable loadings on rotated principle components, variance and cumulative variance explained by components and scores of rotated principal components are saved. They will be used further in the Jupyter Notebook.
```{r}
#READ IN THE FILES
# List all CSV files in the directory
file_names <- list.files(data_dir, pattern = "\\.csv$", full.names = TRUE)

#PERFORM PCA
# Loops over the file names, reads each file, and assigns it to a dynamically named variable
for (file_path in file_names) {
  file_name <- tools::file_path_sans_ext(basename(file_path)) # The file name without extension
  data <- read_csv(file_path, show_col_types = FALSE)
  assign(file_name, data) # Assigns the data to a variable named after the file
  
  #Extracts the year from  a file name to save the output files later in the folder properly
  year <- sub("z_scores_([0-9]+).*", "\\1", file_name)
  
  print(year)
  
  # Checks for missing values
  if(any(is.na(data))){
    print(paste("Missing values found in", file_name))
  } else {
    print(paste("No missing values in", file_name))
  }
  
  # Saves locations from the first column
  locations <- data[,1]
  data <- data[,-1]
  
  # Save variable names from the first row
  variables <- names(data)
  
  # Number of factors for PCA analysis is equal to a number of variables
  number_of_factors = length(variables)
  
  # Performs PCA with varimax rotation
  pca_varimax <- principal(r = data, nfactors = number_of_factors, rotate = "varimax")
  
  # PCA scores
  scores_varimax <- pca_varimax$scores
  scores_with_locations_varimax <- cbind(locations, scores_varimax)
  pca_scores_path <- file.path(results_dir, paste0("PCA_scores_", year,".csv"))
  write_csv(as.data.frame(scores_with_locations_varimax), pca_scores_path)
  print("PCA scores are saved to the ouput->PCA folder")
  
  # Loadings matrix
  loadings_variables <- pca_varimax$loadings
  loadings_var_names <- cbind(variables, loadings_variables)
  loadings_path <- file.path(results_dir, paste0("loadings_", year, ".csv"))
  write_csv(as.data.frame(loadings_var_names), loadings_path)
  print("Loadings are saved to the ouput->PCA folder")
  
  # Eigenvalues
  eigenvalues_path <- file.path(results_dir, paste0("eigenvalues_", year, ".csv"))
  write_csv(as.data.frame(pca_varimax$values), eigenvalues_path)
  print("Eigenvalues are saved to the ouput->PCA folder")
  
  # Proportion of Variance Explained
  proportion_var <- pca_varimax$Vaccounted["Proportion Var", ]
  proportion_var_path <- file.path(results_dir, paste0("proportion_variance_", year, ".csv"))
  write_csv(as.data.frame(proportion_var), proportion_var_path)
  print("Proportion of Variance Explained is saved to the ouput->PCA folder")

  # Cumulative Proportion of Variance Explained
  cumulative_var <- pca_varimax$Vaccounted["Cumulative Var", ]
  cumulative_var_path <- file.path(results_dir, paste0("cumulative_variance_", year, ".csv"))
  write_csv(as.data.frame(cumulative_var), cumulative_var_path)
  print("Cumulative Proportion of Variance Explained is saved to the ouput->PCA folder")
  
  # Writing down all results into a text file
  # Redirects console output to a text file
  output_file_path <- file.path(results_dir, paste0("PCA_output_",year, ".txt"))
  sink(output_file_path)
  
  # Print the PCA analysis output in a text file
  print(paste("Principal Components Analysis for", file_name))
  print(pca_varimax)
  print(pca_varimax$values)
  print(scores_with_locations_varimax)
  
  # Stop redirecting console output to a file
  sink()
}

# End of the PCA analysis
print("All files have been processed for PCA analysis. Return back to Jupyter Notebook.")
```

